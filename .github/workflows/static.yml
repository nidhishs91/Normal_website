
name: Create ServiceNow Change on Push

on:
  push:
    branches:
      - main

jobs:
  create-change:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ServiceNow Create Change
        id: create_change
        uses: ServiceNow/servicenow-devops-change@v3.1.0
        with:
          # --- Auth & Tool mapping ---
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}

          # --- CI/CD context required by the action ---
          # These three are typically mandatory for DCV mapping
          pipeline-name: "${{ github.repository }}"           # e.g., org/repo
          stage-name: "Create Change"                         # any friendly stage label
          job-name: "ServiceNow Create Change"                # must be provided (your error)

          # Full GitHub event context (helps the action enrich the record)
          context-github: ${{ toJSON(github) }}

          # --- Change Request payload (adapt to your DCV policy) ---
          change-request: >-
            {
              "category": "Normal",
              "short_description": "Auto change for push on ${ GITHUB_REF_NAME }",
              "description": "Repository: ${ GITHUB_REPOSITORY }, Commit: ${ GITHUB_SHA }, Actor: ${ GITHUB_ACTOR }",
              "implementation_plan": "Deploy via pipeline after approvals",
              "backout_plan": "Rollback to last stable release",
              "test_plan": "Unit/Integration tests executed in CI",
              "risk": "Low"
            }

      - name: Output created change
        run: |
          echo "Change Number: ${{ steps.create_change.outputs.change-request-number }}"
          echo "Change Sys ID: ${{ steps.create_change.outputs.change-request-sys-id }}"
