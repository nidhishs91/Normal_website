
name: Create ServiceNow Change on Push

on:
  push:
    branches:
      - main
      # add more branches if needed
      # - develop

jobs:
  create-change:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: run build/test first, or use your existing build job and set `needs: build`
      # - name: Setup Node
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '18.x'
      # - name: Install & Test
      #   run: |
      #     npm ci
      #     npm test

      # ðŸ‘‰ Use ServiceNow DevOps Action (token-based, available from v2.0+ on instance)
      - name: ServiceNow Create Change
        id: create_change
        uses: ServiceNow/servicenow-devops-change@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}

          # Change Request payload (adjust to your DCV policy requirements)
          change-request: >-
            {
              "category": "Normal",
              "short_description": "Auto change for push on ${ GITHUB_REF_NAME }",
              "description": "Repository: ${ GITHUB_REPOSITORY }, Commit: ${ GITHUB_SHA }, Actor: ${ GITHUB_ACTOR }",
              "implementation_plan": "Deploy via pipeline after approvals",
              "backout_plan": "Rollback to last stable release",
              "test_plan": "Unit/Integration tests executed in CI",
              "risk": "Low",
              "assignment_group": ""
            }

      - name: Output created change
        run: |
          echo "Change Number: ${{ steps.create_change.outputs.change-request-number }}"
