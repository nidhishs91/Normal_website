
# name: ServiceNow DevOps Change

# on:
#   push:
#     branches: [ "main" ]
#   workflow_dispatch:

# jobs:
#   build:
#     name: Build
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - name: Run Tests
#         run: echo "Running tests..."

#   ServiceNowDevOpsChange:
#     needs: build
#     runs-on: ubuntu-latest
#     name: ServiceNow DevOps Change
#     steps:
#       - uses: actions/checkout@v4

#       - name: ServiceNow Change
#         id: create_change
#         uses: ServiceNow/servicenow-devops-change@v6.1.0
#         with:
#           devops-integration-user-name: ${{ secrets.SN_DEVOPS_USER }}      
#           devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
#           instance-url: ${{ secrets.SN_INSTANCE_URL }}
#           tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
#           context-github: ${{ toJSON(github) }}
#           job-name: "ServiceNow DevOps Change"
#           change-request: |
#            {
#               "setCloseCode": true,
#               "autoCloseChange": true,
#               "attributes": {
#                 "category": "DevOps",
#                 "short_description": "Automated Deployment",
#                 "description": "Create DevOps change from GitHub Actions.",
#                 "implementation_plan": "Automated deploy within approved window",
#                 "backout_plan": "Redeploy previous version",
#                 "test_plan": "Post-deploy smoke tests",
#                 "assignment_group":"b85d44954a3623120004689b2d5dd60a"
#               }
#             }

#           deployment-gate: '{"environment":"github-pages","jobName":"Deploy"}'
  
#           changeCreationTimeOut: 120
#           abortOnChangeCreationFailure: true
#           timeout: 200
#           abortOnChangeStepTimeout: true
#           interval: 500

#       - name: Output of Change Creation
#         run: |
#           echo 'Outputs from create_change:'
#           echo '${{ toJSON(steps.create_change.outputs) }}'
   
#   deploy:
#     name: Deploy
#     runs-on: ubuntu-latest
#     needs: ServiceNowDevOpsChange
#     environment: github-pages


# name: Prod Deploy

# on:
#   push:
#     branches: [ main ]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     name: Build & Test

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Build
#         run: |
#           echo "Build the project..."
#           # Add your build commands here

#       - name: SonarQube Scan
#         uses: sonarsource/sonarqube-scan-action@v1
#         env:
#           SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
#           SONAR_TOKEN:    ${{ secrets.SONAR_TOKEN }}
#         with:
#           projectKey: "nidhishs91"   # Must be string
#           # args: >
#           #   -Dsonar.sources=.
#           #   -Dsonar.projectName="Your Project Name"

#   ServiceNowDevOpsChange:
#     needs: build
#     runs-on: ubuntu-latest
#     name: ServiceNow DevOps Change (Prod Deploy)

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Create ServiceNow DevOps Change
#         id: create_change
#         uses: ServiceNow/servicenow-devops-change@v5.1.0
#         with:
#           devops-integration-user-name:     ${{ secrets.SN_DEVOPS_USER }}
#           devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
#           instance-url: ${{ secrets.SN_INSTANCE_URL }}
#           tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
#           context-github: ${{ toJSON(github) }}
#           job-name: 'ServiceNow DevOps Change'

#       - name: Wait for ServiceNow Change Approval
#         uses: servicenow/devops-change-approval-action@v1
#         with:
#           devops-integration-user-name:     ${{ secrets.SN_DEVOPS_USER }}
#           devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
#           instance_url: ${{ secrets.SN_INSTANCE_URL }}
#           change_id: ${{ steps.create_change.outputs.change_id }}

#       - name: Deploy to Production
#         run: |
#           echo "Approval received. Running Prod deployment..."
#           # Add your deploy commands here



# name: Prod Deploy

# on:
#   push:
#     branches: [ main ]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     name: Build & Test

#     steps:
#       # Pin checkout to a full SHA (example: v4.2.2)
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
#         with:
#           fetch-depth: 0  # improves Sonar reporting across commits

#       - name: Build
#         run: |
#           echo "Build the project..."
#           # Add your build commands here

#       - name: SonarQube (SonarCloud) Scan
#         uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # SonarCloud token
#         with:
#           args: >
#             -Dsonar.organization=nidhishs91
#             -Dsonar.projectKey=nidhishs91_Normal_website
#             -Dsonar.sources=.

#   ServiceNowDevOpsChange:
#     needs: build
#     runs-on: ubuntu-latest
#     name: ServiceNow DevOps Change (Prod Deploy)

#     steps:
#       - name: Checkout
#         uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

#       - name: Create ServiceNow DevOps Change
#         id: create_change
#         uses: ServiceNow/servicenow-devops-change@v5.1.0
#         with:
#           devops-integration-user-name:     ${{ secrets.SN_DEVOPS_USER }}
#           devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
#           instance-url: ${{ secrets.SN_INSTANCE_URL }}
#           tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
#           context-github: ${{ toJSON(github) }}
#           job-name: 'ServiceNow DevOps Change'

#       - name: Wait for ServiceNow Change Approval
#         uses: servicenow/devops-change-approval-action@v1
#         with:
#           devops-integration-user-name:     ${{ secrets.SN_DEVOPS_USER }}
#           devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
#           instance_url: ${{ secrets.SN_INSTANCE_URL }}
#           change_id: ${{ steps.create_change.outputs.change_id }}

#       - name: Deploy to Production
#         run: |
#           echo "Approval received. Running Prod deployment..."
#           # Add your deploy commands here


name: Prod Deploy

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build & Test

    steps:
      # Pin checkout to a full SHA (example: v4.2.2)
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0  # improves Sonar reporting across commits

      - name: Build
        run: |
          echo "Build the project..."
          # Add your build commands here

      - name: SonarQube (SonarCloud) Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # SonarCloud token
        with:
          args: >
            -Dsonar.organization=nidhishs91
            -Dsonar.projectKey=nidhishs91_Normal_website
            -Dsonar.sources=.

  ServiceNowDevOpsChange:
    needs: build
    runs-on: ubuntu-latest
    name: ServiceNow DevOps Change (Prod Deploy)

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Create ServiceNow DevOps Change and wait for approval
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        with:
          devops-integration-user-name:     ${{ secrets.SN_DEVOPS_USER }}
          devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: 'ServiceNow DevOps Change'

          # Optional: customize change request fields
          change-request: >-
            {"setCloseCode":"true","autoCloseChange":true,
             "attributes":{"short_description":"Prod deploy",
               "description":"Automated deployment via GitHub Actions"}}

          # Polling settings: waits until approval
          interval: '30'     # seconds between checks
          timeout: '3600'    # max seconds to wait (1 hour)

      - name: Deploy to Production
        run: |
          echo "Approval received. Running Prod deployment..."
          # Add your deploy commands here

