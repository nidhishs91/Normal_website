
name: Get ServiceNow Change on Push

on:
  push:
    branches:
      - main
      # - develop  # add more branches if you want

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    # If you have an upstream job (like build/test), add:
    # needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ServiceNow Get Change
        id: get_change
        uses: ServiceNow/servicenow-devops-get-change@v3.1.0
        with:
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
          instance-url: ${{ secrets.SN_INSTANCE_URL }}
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          # Provide the details used to identify the change in your DCV mapping
          # You can hardcode values or derive them from GitHub context
          change-details: >-
            {
              "build_number": "${{ github.run_id }}",
              "pipeline_name": "${{ github.workflow }}",
              "stage_name": "Create_Change",
              "attempt_number": "1"
            }

      - name: Output change info
        run: |
          echo "Change Number: ${{ steps.get_change.outputs.change-request-number }}"
          echo "Change Sys ID:  ${{ steps.get_change.outputs.change-request-sys-id }}"
